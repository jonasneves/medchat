name: Deploy MedChat

on:
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Duration (max 5.5 hours)'
        required: false
        default: '5'
        type: string
      auto_restart:
        description: 'Auto-restart before timeout'
        required: false
        default: true
        type: boolean

  repository_dispatch:
    types: [restart-deploy]

env:
  REGISTRY: ghcr.io

jobs:
  deploy:
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 350
    permissions:
      actions: write
      contents: read
      packages: read

    steps:
      - uses: actions/checkout@v4

      - name: Find previous workflow
        id: find_previous
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          API_RESPONSE=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/runs?status=in_progress")

          PREVIOUS_RUN_ID=$(echo "$API_RESPONSE" | jq -r ".workflow_runs[] | select(.id < ${{ github.run_id }}) | .id" | head -1)

          if [ -n "$PREVIOUS_RUN_ID" ] && [ "$PREVIOUS_RUN_ID" != "null" ]; then
            echo "previous_run_id=$PREVIOUS_RUN_ID" >> $GITHUB_OUTPUT
            echo "Found previous run: $PREVIOUS_RUN_ID"
          else
            echo "previous_run_id=" >> $GITHUB_OUTPUT
            echo "No previous run found"
          fi

      - name: Setup swap space
        run: |
          if [ ! -f /swapfile ]; then
            sudo fallocate -l 16G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
          fi
          sudo swapon /swapfile 2>/dev/null || true
          free -h

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull images
        run: |
          docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/medgemma-inference:latest
          docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/medchat:latest

      - name: Start MedGemma inference server
        run: |
          docker run -d \
            --name medgemma-inference \
            -p 8400:8400 \
            -e HF_TOKEN=${{ secrets.HF_TOKEN }} \
            -e N_CTX=8192 \
            -e N_THREADS=4 \
            -e N_BATCH=512 \
            -e OPENBLAS_NUM_THREADS=1 \
            -e OMP_NUM_THREADS=4 \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/medgemma-inference:latest

      - name: Start MedChat server
        run: |
          docker run -d \
            --name medchat \
            -p 8500:8500 \
            -e MEDGEMMA_API_URL=http://172.17.0.1:8400 \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/medchat:latest

      - name: Setup Cloudflare Tunnel
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64 -o cloudflared
          chmod +x cloudflared

      - name: Wait for MedGemma model to load
        run: |
          echo "Waiting for MedGemma inference server..."
          for i in {1..120}; do
            if curl -sf http://localhost:8400/health | grep -q "healthy"; then
              echo "MedGemma server ready!"
              break
            fi
            echo "Attempt $i/120 - waiting..."
            sleep 10
          done

      - name: Start tunnel
        env:
          TUNNEL_TOKEN: ${{ secrets.MEDCHAT_TUNNEL_TOKEN }}
        run: |
          ./cloudflared tunnel run --token "$TUNNEL_TOKEN" &
          sleep 5

      - name: Cancel previous workflow
        if: steps.find_previous.outputs.previous_run_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ steps.find_previous.outputs.previous_run_id }}/cancel"

          echo "Graceful handoff: waiting 30s for previous instance to shutdown"
          sleep 30

      - name: Health check
        run: |
          curl -sf http://localhost:8500/api/health || echo "Backend health check"
          curl -sf http://localhost:8400/health || echo "Inference health check"

      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Monitor
        env:
          APP_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          cleanup() {
            docker stop medchat medgemma-inference 2>/dev/null || true
            docker rm medchat medgemma-inference 2>/dev/null || true
            exit 0
          }
          trap cleanup SIGTERM SIGINT

          DURATION_HOURS="${{ github.event.client_payload.duration_hours || github.event.inputs.duration_hours || '5' }}"
          DURATION=$((DURATION_HOURS * 3600))
          RESTART_THRESHOLD=$((DURATION - 360))
          START_TIME=$(date +%s)
          RESTART_TRIGGERED=false

          AUTO_RESTART="${{ github.event.client_payload.auto_restart || github.event.inputs.auto_restart }}"
          if [ -z "$AUTO_RESTART" ]; then
            AUTO_RESTART="true"
          fi

          echo "Duration: ${DURATION_HOURS}h | Auto-restart: $AUTO_RESTART"

          while true; do
            ELAPSED=$(($(date +%s) - START_TIME))
            REMAINING=$((DURATION - ELAPSED))

            INFERENCE_STATUS=$(docker inspect -f '{{.State.Status}}' medgemma-inference 2>/dev/null || echo "stopped")
            BACKEND_STATUS=$(docker inspect -f '{{.State.Status}}' medchat 2>/dev/null || echo "stopped")

            printf "[%s] Inference: %s | Backend: %s | %dm elapsed | %dm remaining\n" \
              "$(date '+%H:%M:%S')" "$INFERENCE_STATUS" "$BACKEND_STATUS" "$((ELAPSED/60))" "$((REMAINING/60))"

            [ "$INFERENCE_STATUS" != "running" ] && docker start medgemma-inference
            [ "$BACKEND_STATUS" != "running" ] && docker start medchat

            if [ "$ELAPSED" -gt "$RESTART_THRESHOLD" ] && [ "$RESTART_TRIGGERED" = "false" ]; then
              if [ "$AUTO_RESTART" = "true" ]; then
                echo ""
                echo "=========================================="
                echo "Triggering restart workflow..."
                echo "=========================================="

                if [ -z "$APP_TOKEN" ]; then
                  echo "ERROR: APP_TOKEN not available"
                  RESTART_TRIGGERED=true
                else
                  RESPONSE=$(curl -sX POST \
                    -H "Accept: application/vnd.github+json" \
                    -H "Authorization: Bearer $APP_TOKEN" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    https://api.github.com/repos/${{ github.repository }}/dispatches \
                    -d "{\"event_type\":\"restart-deploy\",\"client_payload\":{\"duration_hours\":\"$DURATION_HOURS\",\"auto_restart\":$([ \"$AUTO_RESTART\" = \"true\" ] && echo \"true\" || echo \"false\")}}" \
                    -w "\nHTTP_STATUS:%{http_code}" 2>&1)

                  HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)

                  if [ "$HTTP_CODE" = "204" ]; then
                    echo "SUCCESS: Restart triggered!"
                    echo "Waiting 90s for new instance to start..."
                    sleep 90
                  else
                    echo "ERROR: Failed to trigger restart (HTTP $HTTP_CODE)"
                  fi

                  RESTART_TRIGGERED=true
                fi
              fi
            fi

            [ $ELAPSED -gt $DURATION ] && break
            sleep 30
          done

          cleanup

      - name: Show logs on failure
        if: failure()
        run: |
          docker logs medgemma-inference 2>&1 | tail -100
          docker logs medchat 2>&1 | tail -50
