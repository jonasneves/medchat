name: Deploy MedChat

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  deploy:
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 360
    permissions:
      actions: write
      contents: read
      packages: read

    steps:
      - uses: actions/checkout@v4

      - name: Find previous workflow
        id: find_previous
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          API_RESPONSE=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/runs?status=in_progress")

          PREVIOUS_RUN_ID=$(echo "$API_RESPONSE" | jq -r ".workflow_runs[] | select(.id < ${{ github.run_id }}) | .id" | head -1)

          if [ -n "$PREVIOUS_RUN_ID" ] && [ "$PREVIOUS_RUN_ID" != "null" ]; then
            echo "previous_run_id=$PREVIOUS_RUN_ID" >> $GITHUB_OUTPUT
            echo "Found previous run: $PREVIOUS_RUN_ID"
          else
            echo "previous_run_id=" >> $GITHUB_OUTPUT
            echo "No previous run found"
          fi

      - name: Setup swap space
        run: |
          if [ ! -f /swapfile ]; then
            sudo fallocate -l 16G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
          fi
          sudo swapon /swapfile 2>/dev/null || true
          free -h

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull images
        run: |
          docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/medgemma-inference:latest
          docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/medchat:latest

      - name: Start MedGemma inference server
        run: |
          docker run -d \
            --name medgemma-inference \
            -p 8400:8400 \
            -e HF_TOKEN=${{ secrets.HF_TOKEN }} \
            -e N_CTX=8192 \
            -e N_THREADS=4 \
            -e N_BATCH=512 \
            -e OPENBLAS_NUM_THREADS=1 \
            -e OMP_NUM_THREADS=4 \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/medgemma-inference:latest

      - name: Start MedChat server
        run: |
          docker run -d \
            --name medchat \
            -p 8500:8500 \
            -e MEDGEMMA_API_URL=http://172.17.0.1:8400 \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/medchat:latest

      - name: Setup Cloudflare Tunnel
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64 -o cloudflared
          chmod +x cloudflared

      - name: Wait for MedGemma model to load
        run: |
          echo "Waiting for MedGemma inference server..."
          for i in {1..120}; do
            if curl -sf http://localhost:8400/health | grep -q "healthy"; then
              echo "MedGemma server ready!"
              break
            fi
            echo "Attempt $i/120 - waiting..."
            sleep 10
          done

      - name: Start tunnel
        env:
          TUNNEL_TOKEN: ${{ secrets.MEDCHAT_TUNNEL_TOKEN }}
        run: |
          ./cloudflared tunnel run --token "$TUNNEL_TOKEN" &
          sleep 5

      - name: Cancel previous workflow
        if: steps.find_previous.outputs.previous_run_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ steps.find_previous.outputs.previous_run_id }}/cancel"

          echo "Graceful handoff: waiting 30s for previous instance to shutdown"
          sleep 30

      - name: Health check
        run: |
          curl -sf http://localhost:8500/api/health || echo "Backend health check"
          curl -sf http://localhost:8400/health || echo "Inference health check"

      - name: Keep alive
        run: |
          echo "MedChat is running..."
          echo "Inference: http://localhost:8400"
          echo "Backend: http://localhost:8500"
          while true; do
            sleep 300
            echo "$(date): Still running..."
            docker ps
          done
